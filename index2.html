<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŒ—æµ·é“æ«»èŠ±ä¹‹æ—… ğŸŒ¸</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Doraemon & Sakura Theme */
        :root {
            --dora-blue: #0096FF;
            --dora-red: #E60033;
            --sakura-bg: #FFF0F5;
            --glass: rgba(255, 255, 255, 0.85);
        }

        body {
            background-color: var(--sakura-bg);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            color: #333;
        }

        /* Sakura Animation */
        .sakura {
            position: fixed;
            top: -10vh;
            background-color: #ffb7c5;
            border-radius: 100% 0 100% 0;
            opacity: 0.8;
            transform-origin: center bottom;
            animation: fall linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes fall {
            0% { transform: translateY(0) rotate(0deg) translateX(0); opacity: 0.9; }
            100% { transform: translateY(110vh) rotate(360deg) translateX(50px); opacity: 0.3; }
        }

        /* Utilities */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .zoom-in {
            animation: zoomIn 0.3s ease-out forwards;
        }
        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Custom Inputs */
        input:focus, select:focus {
            outline: 2px solid var(--dora-blue);
            outline-offset: 1px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Data: 4/22 - 4/28 Hokkaido Itinerary ---
        const initialSchedule = [
            {
                date: "4/22 (Day 1)",
                city: "Chitose",
                events: [
                    { time: "16:00", title: "æ©Ÿå ´å‡ºé—œ âœˆï¸", desc: "æ–°åƒæ­²æ©Ÿå ´", type: "plane", note: "æ‹¿è¡Œæã€å…¥å¢ƒ" },
                    { time: "16:30", title: "å‰å¾€åƒæ­²ç«™ ğŸš†", desc: "JR ç§»å‹•", type: "train", note: "" },
                    { time: "16:30", title: "å¯„æ”¾è¡Œæ ğŸ›…", desc: "åƒæ­²ç«™ç½®ç‰©æ«ƒ", type: "briefcase", note: "è¨˜å¥½ä½ç½®å¯†ç¢¼" },
                    { time: "18:00", title: "ES CON FIELD âš¾", desc: "çƒå ´åƒè§€/çœ‹çƒ", type: "dribbble", note: "åŒ—æµ·é“æ—¥æœ¬ç«è…¿é¬¥å£«éšŠä¸»å ´" },
                    { time: "21:30", title: "å‰å¾€é£¯åº— ğŸ¨", desc: "Check-in JR INN", type: "bed", note: "hotel.com å·²ä»˜æ¬¾" }
                ]
            },
            {
                date: "4/23 (Day 2)",
                city: "Noboribetsu",
                events: [
                    { time: "09:30", title: "é£¯åº—å‡ºç™¼ â˜€ï¸", desc: "å‰å¾€æ©Ÿå ´å–è»Š", type: "sun", note: "" },
                    { time: "10:30", title: "æ©Ÿå ´å–è»Š ğŸš—", desc: "æª¢æŸ¥ ETC å¡", type: "car", note: "ç¢ºèªè»Šæ³ã€ä¿éšª" },
                    { time: "11:00", title: "ä¸‰äº• Outlet Park ğŸ›ï¸", desc: "åˆé¤ & é€›è¡—", type: "shopping-bag", note: "åŒ—å»£å³¶" },
                    { time: "14:00", title: "å‰å¾€ç™»åˆ¥ ğŸ›£ï¸", desc: "é“å¤®è‡ªå‹•è»Šé“", type: "map", note: "è»Šç¨‹ç´„ 1h 15m" },
                    { time: "15:15", title: "ç™»åˆ¥åœ°ç„è°· ğŸ‘¹", desc: "æ•£æ­¥æ‹ç…§", type: "flame", note: "ç›´å¾‘450mç«å±±å£" },
                    { time: "16:30", title: "å…¥ä½æº«æ³‰é£¯åº— â™¨ï¸", desc: "ç™»åˆ¥ Grand Hotel", type: "bath", note: "agoda å·²ä»˜ï¼Œäº«å—æ™šé¤" }
                ]
            },
            {
                date: "4/24 (Day 3)",
                city: "Hakodate",
                events: [
                    { time: "09:30", title: "é€€æˆ¿å‡ºç™¼ ğŸš—", desc: "å‰å¾€æ´çˆºæ¹–", type: "car", note: "" },
                    { time: "10:30", title: "æ´çˆºæ¹–å±•æœ›å° ğŸ”ï¸", desc: "Silo Platform", type: "camera", note: "å¿…æ‹æ™¯é»" },
                    { time: "11:30", title: "å‰å¾€å‡½é¤¨ ğŸ›£ï¸", desc: "é•·é€”ç§»å‹•", type: "map", note: "è»Šç¨‹ç´„ 2 å°æ™‚" },
                    { time: "13:30", title: "å°ä¸‘æ¼¢å ¡ ğŸ”", desc: "å³ ä¸‹ç¸½æœ¬åº—", type: "utensils", note: "å¿…é»ä¸­è¯é›è‚‰å ¡" },
                    { time: "15:00", title: "äº”ç¨œéƒ­å…¬åœ’ ğŸŒ¸", desc: "æ˜Ÿå½¢è¦å¡è³æ«»", type: "flower", note: "ç™»ä¸Šäº”ç¨œéƒ­å¡”?" },
                    { time: "17:30", title: "æˆå‰æ€æ±— å¤§é–€ ğŸ¥©", desc: "çƒ¤è‚‰æ™šé¤", type: "flame", note: "â˜…éœ€é ç´„" },
                    { time: "19:30", title: "å‡½é¤¨å±±å¤œæ™¯ ğŸŒƒ", desc: "æ­ä¹˜çºœè»Š", type: "moon", note: "ç™¾è¬å¤œæ™¯" },
                    { time: "21:00", title: "å…¥ä½é£¯åº— ğŸ¨", desc: "Global View Hakodate", type: "bed", note: "trip å·²ä»˜" }
                ]
            },
            {
                date: "4/25 (Day 4)",
                city: "Jozankei",
                events: [
                    { time: "08:00", title: "å‡½é¤¨æœå¸‚ ğŸ¦‘", desc: "é‡£çƒè³Šé«”é©—", type: "fish", note: "åƒæµ·é®®ä¸¼" },
                    { time: "09:30", title: "æº–æ™‚å‡ºç™¼ ğŸš—", desc: "é•·é€”ç§»å‹•å¾€äºŒä¸–è°·", type: "car", note: "" },
                    { time: "12:30", title: "é«˜æ©‹ç‰§å ´ ğŸ¥›", desc: "äºŒä¸–è°·", type: "milk", note: "å–ç‰›å¥¶ã€åƒå†°æ·‡æ·‹" },
                    { time: "14:00", title: "å‰å¾€å®šå±±æºª ğŸ›£ï¸", desc: "ç¶“ä¸­å±±å³ ", type: "map", note: "" },
                    { time: "16:00", title: "æ£®ä¹‹æ­Œ Lounge ğŸ·", desc: "è½è±ç´ã€çƒ¤æ£‰èŠ±ç³–", type: "music", note: "äº«å—é£¯åº—è¨­æ–½" },
                    { time: "17:00", title: "Check-in â™¨ï¸", desc: "å®šå±±æºªé¶´é›… æ£®ä¹‹æ­Œ", type: "bed", note: "agoda å·²ä»˜" }
                ]
            },
            {
                date: "4/26 (Day 5)",
                city: "Otaru",
                events: [
                    { time: "09:30", title: "é€€æˆ¿å‡ºç™¼ ğŸš—", desc: "å‰å¾€æ»‘é›ªå ´", type: "car", note: "" },
                    { time: "10:00", title: "æœ­å¹Œåœ‹éš›æ»‘é›ªå ´ ğŸ‚", desc: "é«”é©—æ˜¥é›ª", type: "snowflake", note: "ç©é›ªè¡Œç¨‹" },
                    { time: "11:00", title: "ä¸‹å±±å‰å¾€å°æ¨½ ğŸ›£ï¸", desc: "ç§»å‹•", type: "map", note: "" },
                    { time: "11:45", title: "æ‰‹å®®å…¬åœ’ ğŸŒ¸", desc: "æµ·æ™¯æ«»èŠ±", type: "flower", note: "è³æ«»ç§˜å¢ƒ" },
                    { time: "13:00", title: "æ‹‰éºµ Mikan ğŸœ", desc: "åˆé¤", type: "utensils", note: "æ¿ƒåšå‘³å™Œæ¹¯é ­" },
                    { time: "14:30", title: "å°æ¨½é‹æ²³ & å ºç”ºé€š ğŸ°", desc: "ç”œé»å·¡ç¦®", type: "coffee", note: "LeTAO, åŒ—è“æ¨“, å…­èŠ±äº­" },
                    { time: "17:30", title: "å°æ¨½æµ·é®®/å£½å¸ ğŸ£", desc: "ä¼Šå‹¢é®¨ / é­šçœŸ", type: "fish", note: "æ™šé¤" },
                    { time: "19:30", title: "å¤©ç‹—å±±å¤œæ™¯ ğŸŒƒ", desc: "å°æ¨½å¤œæ™¯", type: "moon", note: "ä¸‰å¤§å¤œæ™¯ä¹‹ä¸€" },
                    { time: "21:00", title: "Check-in ğŸ¨", desc: "Hotel Torifito", type: "bed", note: "trip å·²ä»˜" }
                ]
            },
            {
                date: "4/27 (Day 6)",
                city: "Sapporo",
                events: [
                    { time: "09:30", title: "é€€æˆ¿å‰å¾€æœ­å¹Œ ğŸš—", desc: "ç§»å‹•", type: "car", note: "" },
                    { time: "10:15", title: "åŒ—æµ·é“ç¥å®® â›©ï¸", desc: "åƒæ‹œ", type: "landmark", note: "åƒåˆ¤å®˜é¤…" },
                    { time: "12:00", title: "Soup Curry KING ğŸ›", desc: "æ¹¯å’–å“©", type: "utensils", note: "Wæ¹¯é ­" },
                    { time: "14:00", title: "AEON ç™¼å¯’åº— ğŸ›ï¸", desc: "æœ€å¾Œæ¡è²·", type: "shopping-bag", note: "ä¼´æ‰‹ç¦®" },
                    { time: "17:00", title: "Check-in / é‚„è»Š ğŸš—", desc: "Cross Hotel", type: "check-circle", note: "agoda å·²ä»˜" },
                    { time: "18:30", title: "å¤œç©ºæˆå‰æ€æ±— ğŸ¥©", desc: "æ™šé¤", type: "flame", note: "â˜…å‹™å¿…é ç´„" }
                ]
            },
            {
                date: "4/28 (Day 7)",
                city: "Home",
                events: [
                    { time: "08:30", title: "é£¯åº—å‡ºç™¼ â˜€ï¸", desc: "æœ€å¾Œä¸€å¤©", type: "sun", note: "" },
                    { time: "08:30", title: "å‡ºç™¼è‡³çƒå ´ âš¾", desc: "å†æ¬¡å‰å¾€", type: "dribbble", note: "" },
                    { time: "10:00", title: "çƒå ´å°è¦½ ğŸš¶", desc: "Tour", type: "info", note: "" },
                    { time: "12:30", title: "æŠµé”é‚„è»Šåœ° ğŸš—", desc: "å¦‚æœå°šæœªé‚„è»Š", type: "car", note: "" },
                    { time: "13:00", title: "æ©Ÿå ´æ¡è²· âœˆï¸", desc: "æ–°åƒæ­²æ©Ÿå ´", type: "shopping-bag", note: "æœ€å¾Œè¡åˆº" },
                    { time: "16:00", title: "ç”œèœœçš„å®¶ ğŸ ", desc: "End", type: "heart", note: "å¹³å®‰å›å®¶" }
                ]
            }
        ];

        const translationCards = [
            { jp: "ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼æº€ã‚¿ãƒ³", py: "Regular Mantan", zh: "95 åŠ æ»¿ (ä¸€èˆ¬æ±½æ²¹)" },
            { jp: "ç¾é‡‘ã§æ‰•ã„ã¾ã™", py: "Genkin de haraimasu", zh: "ç¾é‡‘ä»˜æ¬¾" },
            { jp: "ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™", py: "Okaikei Onegaishimasu", zh: "æˆ‘è¦çµå¸³" },
            { jp: "ãŠæ°´ãã ã•ã„", py: "Omizu Kudasai", zh: "è«‹çµ¦æˆ‘æ°´" },
            { jp: "è¢‹ã„ã‚Šã¾ã›ã‚“", py: "Fukuro Irimasen", zh: "ä¸ç”¨è¢‹å­" },
            { jp: "é§è»Šå ´ã¯ã©ã“ã§ã™ã‹ï¼Ÿ", py: "Chuushajou wa doko desuka", zh: "åœè»Šå ´åœ¨å“ªï¼Ÿ" }
        ];

        // --- Custom Hook: useStickyState (Robust) ---
        function useStickyState(defaultValue, key) {
            const [value, setValue] = useState(() => {
                try {
                    const stickyValue = window.localStorage.getItem(key);
                    return stickyValue !== null && stickyValue !== "undefined"
                        ? JSON.parse(stickyValue)
                        : defaultValue;
                } catch (error) {
                    console.error(`Error parsing localStorage key "${key}":`, error);
                    return defaultValue;
                }
            });

            useEffect(() => {
                try {
                    window.localStorage.setItem(key, JSON.stringify(value));
                } catch (error) {
                    console.error(`Error saving localStorage key "${key}":`, error);
                }
            }, [key, value]);

            return [value, setValue];
        }

        // --- Components ---

        // FIXED ICON COMPONENT: Uses a ref container to isolate Lucide's DOM manipulation from React
        const Icon = ({ name, size = 20, className = "" }) => {
            const containerRef = useRef(null);

            useEffect(() => {
                if (!containerRef.current || !window.lucide) return;

                // Clean up previous content
                containerRef.current.innerHTML = '';

                // Create the element that Lucide will replace
                const iconElement = document.createElement('i');
                iconElement.setAttribute('data-lucide', name);
                iconElement.setAttribute('width', size);
                iconElement.setAttribute('height', size);
                if (className) iconElement.setAttribute('class', className);

                // Append to our container
                containerRef.current.appendChild(iconElement);

                // Tell Lucide to transform it
                window.lucide.createIcons({
                    root: containerRef.current,
                    nameAttr: 'data-lucide'
                });

            }, [name, size, className]);

            // Render a stable container that React controls. 
            // Lucide manipulates the *children* of this container, so React doesn't get confused.
            return <span ref={containerRef} style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }}></span>;
        };

        const SakuraBg = () => {
            const flakes = useMemo(() => Array.from({ length: 15 }).map((_, i) => ({
                id: i,
                left: Math.random() * 100 + "vw",
                duration: (Math.random() * 5 + 5) + "s",
                delay: Math.random() * 5 + "s",
                size: (Math.random() * 10 + 10) + "px"
            })), []);

            return (
                <div className="fixed inset-0 pointer-events-none z-0 overflow-hidden">
                    {flakes.map(f => (
                        <div key={f.id} className="sakura" style={{
                            left: f.left,
                            animationDuration: f.duration,
                            animationDelay: f.delay,
                            width: f.size,
                            height: f.size
                        }}></div>
                    ))}
                </div>
            );
        };

        // --- Tab 1: Schedule ---
        const ScheduleTab = ({ data, setData }) => {
            const [dayIndex, setDayIndex] = useState(0);
            const [isEditing, setIsEditing] = useState(false);

            const handleUpdateEvent = (eIdx, field, value) => {
                setData(prevData => {
                    const newData = [...prevData];
                    const dayEvents = [...newData[dayIndex].events];
                    dayEvents[eIdx] = { ...dayEvents[eIdx], [field]: value };
                    newData[dayIndex] = { ...newData[dayIndex], events: dayEvents };
                    return newData;
                });
            };

            const openMap = (event) => {
                if (isEditing) return;
                const query = event.mapUrl || event.title.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,''); 
                const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
                window.open(url, '_blank');
            };

            const currentDay = data[dayIndex];

            return (
                <div className="space-y-4 pb-24 relative z-10 animate-fade-in">
                    {/* Day Selector */}
                    <div className="flex overflow-x-auto gap-2 p-2 hide-scrollbar sticky top-16 z-20 bg-[var(--sakura-bg)]/90 backdrop-blur">
                        {data.map((day, idx) => (
                            <button 
                                key={idx}
                                onClick={() => setDayIndex(idx)}
                                className={`whitespace-nowrap px-4 py-2 rounded-full font-bold transition-all border-2 shadow-sm ${
                                    dayIndex === idx 
                                    ? 'bg-[#0096FF] text-white border-[#0096FF] scale-105' 
                                    : 'bg-white text-gray-500 border-white hover:bg-gray-50'
                                }`}
                            >
                                {day.date.split(' ')[0]}
                            </button>
                        ))}
                    </div>

                    {/* Day Header */}
                    <div className="glass-card rounded-2xl p-4 shadow-sm mx-2 flex justify-between items-center border-l-4 border-[#0096FF]">
                        <div>
                            <h2 className="text-xl font-bold text-gray-800">{currentDay.date}</h2>
                            <div className="flex items-center gap-2 mt-1">
                                <span className="text-sm text-gray-500 font-medium bg-blue-50 px-2 py-0.5 rounded">{currentDay.city}</span>
                                <a 
                                    href="https://tenki.jp/forecast/1/2/" 
                                    target="_blank"
                                    className="text-xs bg-[#E60033] text-white px-2 py-1 rounded-full flex items-center gap-1 shadow-sm hover:opacity-90"
                                >
                                    <Icon name="cloud-sun" size={12} /> å¤©æ°£
                                </a>
                            </div>
                        </div>
                        <button 
                            onClick={() => setIsEditing(!isEditing)}
                            className={`p-2 rounded-full shadow-sm transition ${isEditing ? 'bg-green-100 text-green-600' : 'bg-white text-gray-400'}`}
                        >
                            <Icon name={isEditing ? "check" : "edit-3"} size={20} />
                        </button>
                    </div>

                    {/* Events */}
                    <div className="space-y-3 px-2">
                        {currentDay.events.map((event, idx) => (
                            <div 
                                key={idx} 
                                onClick={() => openMap(event)}
                                className={`glass-card rounded-xl p-4 shadow-sm transition-all active:scale-[0.99] border-l-4 ${
                                    event.time < "12:00" ? "border-blue-300" : "border-pink-300"
                                }`}
                            >
                                <div className="flex gap-4">
                                    <div className="flex flex-col items-center gap-1 min-w-[50px]">
                                        <div className="bg-white p-2.5 rounded-full text-[#0096FF] shadow-sm">
                                            <Icon name={event.type || "circle"} size={20} />
                                        </div>
                                        {isEditing ? (
                                            <input 
                                                value={event.time} 
                                                onChange={(e) => handleUpdateEvent(idx, 'time', e.target.value)}
                                                className="w-full text-xs text-center border rounded p-1"
                                                onClick={(e) => e.stopPropagation()}
                                            />
                                        ) : (
                                            <span className="text-sm font-bold text-gray-600 font-mono">{event.time}</span>
                                        )}
                                    </div>

                                    <div className="flex-1 space-y-1">
                                        {isEditing ? (
                                            <div className="space-y-2" onClick={(e) => e.stopPropagation()}>
                                                <input value={event.title} onChange={(e) => handleUpdateEvent(idx, 'title', e.target.value)} className="w-full font-bold border rounded p-1" placeholder="æ¨™é¡Œ"/>
                                                <input value={event.desc} onChange={(e) => handleUpdateEvent(idx, 'desc', e.target.value)} className="w-full text-sm border rounded p-1" placeholder="èªªæ˜"/>
                                                <input value={event.note} onChange={(e) => handleUpdateEvent(idx, 'note', e.target.value)} className="w-full text-xs border rounded p-1" placeholder="å‚™è¨»"/>
                                                <input value={event.mapUrl || ""} onChange={(e) => handleUpdateEvent(idx, 'mapUrl', e.target.value)} className="w-full text-xs border rounded p-1 text-blue-500" placeholder="Google Maps URL (Optional)"/>
                                            </div>
                                        ) : (
                                            <>
                                                <h3 className="font-bold text-lg text-gray-800 leading-tight">{event.title}</h3>
                                                <p className="text-sm text-gray-600">{event.desc}</p>
                                                {event.note && (
                                                    <div className="bg-yellow-50 text-yellow-800 text-xs px-2 py-1 rounded inline-block mt-1 border border-yellow-100">
                                                        ğŸ’¡ {event.note}
                                                    </div>
                                                )}
                                            </>
                                        )}
                                    </div>
                                    {!isEditing && <Icon name="chevron-right" className="text-gray-300 self-center" size={16} />}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- Tab 2: Budget (Strict Logic) ---
        const BudgetTab = ({ expenses, setExpenses }) => {
            const [newItem, setNewItem] = useState({ title: "", amount: "", category: "food", payer: "boy", method: "card", currency: "JPY" });

            const addExpense = (e) => {
                e.preventDefault();
                if (!newItem.title || !newItem.amount) return;
                setExpenses(prev => [...prev, { ...newItem, id: Date.now(), timestamp: new Date().toISOString() }]);
                setNewItem({ title: "", amount: "", category: "food", payer: "boy", method: "card", currency: "JPY" });
            };

            const removeExpense = (id) => {
                if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) setExpenses(prev => prev.filter(ex => ex.id !== id));
            };

            const stats = useMemo(() => {
                let totalCashJPY = 0;
                let totalCardTWD = 0;
                
                // Settlement data
                let boyPaidJPY = 0;
                let girlPaidJPY = 0;
                let boyPaidTWD = 0;
                let girlPaidTWD = 0;

                expenses.forEach(ex => {
                    const amt = parseFloat(ex.amount);
                    
                    // 1. Dashboard Logic
                    if (ex.method === 'cash' && ex.currency === 'JPY') {
                        totalCashJPY += amt;
                    }
                    if (ex.method === 'card') {
                        if (ex.currency === 'JPY') {
                            totalCardTWD += (amt * 0.22); // Convert rate
                        } else {
                            totalCardTWD += amt;
                        }
                    }

                    // 2. Settlement Logic (Separate by currency directly)
                    if (ex.currency === 'JPY') {
                        if (ex.payer === 'boy') boyPaidJPY += amt;
                        else girlPaidJPY += amt;
                    } else { // TWD
                        if (ex.payer === 'boy') boyPaidTWD += amt;
                        else girlPaidTWD += amt;
                    }
                });

                const diffJPY = (boyPaidJPY - girlPaidJPY) / 2;
                const diffTWD = (boyPaidTWD - girlPaidTWD) / 2;

                return { totalCashJPY, totalCardTWD, diffJPY, diffTWD };
            }, [expenses]);

            return (
                <div className="space-y-4 pb-24 relative z-10 animate-fade-in px-2">
                    {/* Input Form */}
                    <div className="glass-card rounded-2xl p-4 shadow-sm border-t-4 border-[#0096FF]">
                        <h2 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <Icon name="plus-circle" className="text-[#0096FF]" /> æ–°å¢æ”¯å‡º
                        </h2>
                        <form onSubmit={addExpense} className="space-y-3">
                            <div className="flex gap-2">
                                <input 
                                    className="flex-1 p-2 border rounded bg-white/80" 
                                    placeholder="é …ç›® (å¦‚: æ¹¯å’–å“©)" 
                                    value={newItem.title}
                                    onChange={e => setNewItem({...newItem, title: e.target.value})}
                                />
                                <input 
                                    className="w-24 p-2 border rounded bg-white/80" 
                                    type="number" 
                                    placeholder="é‡‘é¡" 
                                    value={newItem.amount}
                                    onChange={e => setNewItem({...newItem, amount: e.target.value})}
                                />
                            </div>
                            
                            <div className="grid grid-cols-3 gap-2 text-sm">
                                {/* Currency */}
                                <div className="bg-white/60 p-1 rounded-lg flex gap-1 justify-center">
                                    {['JPY', 'TWD'].map(c => (
                                        <button type="button" key={c}
                                            onClick={() => setNewItem({...newItem, currency: c})}
                                            className={`flex-1 rounded py-1 transition ${newItem.currency === c ? 'bg-yellow-400 text-white font-bold shadow' : 'text-gray-400'}`}
                                        >{c}</button>
                                    ))}
                                </div>
                                {/* Payer */}
                                <div className="bg-white/60 p-1 rounded-lg flex gap-1 justify-center">
                                    <button type="button" onClick={() => setNewItem({...newItem, payer: 'boy'})} className={`flex-1 rounded py-1 transition ${newItem.payer === 'boy' ? 'bg-[#0096FF] text-white shadow' : 'text-gray-400'}`}>ğŸ‘¦</button>
                                    <button type="button" onClick={() => setNewItem({...newItem, payer: 'girl'})} className={`flex-1 rounded py-1 transition ${newItem.payer === 'girl' ? 'bg-[#E60033] text-white shadow' : 'text-gray-400'}`}>ğŸ‘§</button>
                                </div>
                                {/* Method */}
                                <div className="bg-white/60 p-1 rounded-lg flex gap-1 justify-center">
                                    <button type="button" onClick={() => setNewItem({...newItem, method: 'cash'})} className={`flex-1 rounded py-1 transition ${newItem.method === 'cash' ? 'bg-green-500 text-white shadow' : 'text-gray-400'}`}>ğŸ’µ</button>
                                    <button type="button" onClick={() => setNewItem({...newItem, method: 'card'})} className={`flex-1 rounded py-1 transition ${newItem.method === 'card' ? 'bg-purple-500 text-white shadow' : 'text-gray-400'}`}>ğŸ’³</button>
                                </div>
                            </div>
                            
                            <button className="w-full bg-[#0096FF] text-white py-2 rounded-lg font-bold shadow-md active:scale-[0.98] transition">
                                è¨˜å¸³
                            </button>
                        </form>
                    </div>

                    {/* Dashboard */}
                    <div className="grid grid-cols-2 gap-3">
                        <div className="glass-card p-3 rounded-xl shadow-sm border-l-4 border-green-500">
                            <p className="text-xs text-gray-500 font-bold mb-1">ç¾é‡‘ç¸½æ”¯å‡º (JPY)</p>
                            <p className="text-2xl font-black text-gray-800">Â¥{stats.totalCashJPY.toLocaleString()}</p>
                            <p className="text-[10px] text-gray-400 mt-1">åƒ…è¨ˆç®—æ—¥å¹£ç¾é‡‘</p>
                        </div>
                        <div className="glass-card p-3 rounded-xl shadow-sm border-l-4 border-purple-500">
                            <p className="text-xs text-gray-500 font-bold mb-1">åˆ·å¡ç¸½æ”¯å‡º (TWD)</p>
                            <p className="text-2xl font-black text-gray-800">${Math.round(stats.totalCardTWD).toLocaleString()}</p>
                            <p className="text-[10px] text-gray-400 mt-1">æ—¥å¹£åˆ·å¡ x 0.22</p>
                        </div>
                    </div>

                    {/* Settlement */}
                    <div className="bg-[#FFF8DC] border border-yellow-200 rounded-xl p-3 shadow-sm">
                        <h3 className="font-bold text-yellow-800 text-sm mb-2 flex items-center gap-1">
                            <Icon name="scale" size={14}/> çµç®—çµæœ (AAåˆ¶)
                        </h3>
                        <div className="space-y-2 text-sm">
                            <div className="flex justify-between items-center border-b border-yellow-200 pb-1">
                                <span className="text-gray-600">ğŸ’´ æ—¥å¹£å·®é¡</span>
                                {stats.diffJPY === 0 ? <span className="text-green-600 font-bold">å…©æ¸…</span> : (
                                    stats.diffJPY > 0 ? 
                                    <span className="font-bold text-[#E60033]">ğŸ‘§ å¥³å‹éœ€çµ¦ Â¥{Math.abs(stats.diffJPY).toLocaleString()}</span> : 
                                    <span className="font-bold text-[#0096FF]">ğŸ‘¦ ç”·å‹éœ€çµ¦ Â¥{Math.abs(stats.diffJPY).toLocaleString()}</span>
                                )}
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-gray-600">ğŸ’° å°å¹£å·®é¡</span>
                                {stats.diffTWD === 0 ? <span className="text-green-600 font-bold">å…©æ¸…</span> : (
                                    stats.diffTWD > 0 ? 
                                    <span className="font-bold text-[#E60033]">ğŸ‘§ å¥³å‹éœ€çµ¦ ${Math.abs(stats.diffTWD).toLocaleString()}</span> : 
                                    <span className="font-bold text-[#0096FF]">ğŸ‘¦ ç”·å‹éœ€çµ¦ ${Math.abs(stats.diffTWD).toLocaleString()}</span>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* List */}
                    <div className="space-y-2">
                        {expenses.length === 0 && <div className="text-center text-gray-400 py-4 text-sm">é‚„æ²’æœ‰ç´€éŒ„å–”ï½</div>}
                        {expenses.slice().reverse().map(ex => (
                            <div key={ex.id} className="glass-card rounded-lg p-3 flex justify-between items-center">
                                <div>
                                    <p className="font-bold text-gray-800">{ex.title}</p>
                                    <p className="text-[10px] text-gray-500 flex gap-1 mt-1">
                                        <span className={`px-1 rounded ${ex.payer === 'boy' ? 'bg-blue-100 text-blue-600' : 'bg-red-100 text-red-600'}`}>
                                            {ex.payer === 'boy' ? 'ğŸ‘¦' : 'ğŸ‘§'}
                                        </span>
                                        <span className="bg-gray-100 px-1 rounded">{ex.method === 'cash' ? 'ç¾é‡‘' : 'åˆ·å¡'}</span>
                                    </p>
                                </div>
                                <div className="text-right">
                                    <p className={`font-mono font-bold ${ex.currency === 'JPY' ? 'text-green-600' : 'text-purple-600'}`}>
                                        {ex.currency === 'JPY' ? 'Â¥' : '$'}{parseFloat(ex.amount).toLocaleString()}
                                    </p>
                                    <button onClick={() => removeExpense(ex.id)} className="text-gray-300 hover:text-red-500 mt-1">
                                        <Icon name="trash-2" size={14} />
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- Tab 3: Utility ---
        const UtilityTab = ({ resetData, exportData, importData }) => {
            const [activeCard, setActiveCard] = useState(null);
            const fileInputRef = useRef(null);

            return (
                <div className="pb-24 relative z-10 px-2 space-y-4 animate-fade-in">
                    {/* Header */}
                    <div className="glass-card rounded-2xl p-4 shadow-sm flex items-center gap-3 bg-gradient-to-r from-[#0096FF] to-[#00c6ff] text-white border-none">
                        <div className="bg-white/20 p-2 rounded-full">
                            <Icon name="pocket" />
                        </div>
                        <div>
                            <h2 className="font-bold text-lg">ç™¾å¯¶è¢‹ ğŸ›ï¸</h2>
                            <p className="text-xs text-white/80">æ—…è¡Œå¿…å‚™å·¥å…·</p>
                        </div>
                    </div>

                    {/* Translation Grid */}
                    <h3 className="font-bold text-gray-700 ml-1 flex items-center gap-1"><Icon name="languages" size={16}/> ç¿»è­¯å¤§å­—å ±</h3>
                    <div className="grid grid-cols-2 gap-3">
                        {translationCards.map((card, idx) => (
                            <button 
                                key={idx}
                                onClick={() => setActiveCard(card)}
                                className="glass-card p-4 rounded-xl shadow-sm hover:bg-white transition-all text-left border-b-4 border-gray-200 active:translate-y-1 active:border-b-0"
                            >
                                <p className="font-bold text-gray-800 mb-1">{card.zh}</p>
                                <p className="text-xs text-gray-400">{card.py}</p>
                            </button>
                        ))}
                    </div>

                    {/* Modal */}
                    {activeCard && (
                        <div 
                            className="fixed inset-0 bg-[#0096FF] z-50 flex flex-col items-center justify-center p-6 text-center cursor-pointer animate-fade-in"
                            onClick={() => setActiveCard(null)}
                        >
                            <p className="text-white/60 mb-8 text-xl">é»æ“Šé—œé–‰</p>
                            <div className="zoom-in bg-white text-[#333] p-8 rounded-3xl shadow-2xl w-full max-w-xs">
                                <h1 className="font-black text-4xl leading-snug mb-4 break-words">{activeCard.jp}</h1>
                                <p className="text-gray-500 text-xl border-t border-gray-200 pt-4">{activeCard.zh}</p>
                            </div>
                            <div className="mt-12 bg-white/20 p-4 rounded-full text-white hover:bg-white/30 transition">
                                <Icon name="x" size={32} />
                            </div>
                        </div>
                    )}

                    {/* Data Management */}
                    <div className="glass-card rounded-2xl p-4 shadow-sm border-t-4 border-yellow-400 mt-6">
                        <h3 className="font-bold text-gray-800 mb-2 flex items-center gap-2">
                            <Icon name="save" size={16} /> è³‡æ–™å‚™ä»½
                        </h3>
                        <p className="text-xs text-gray-500 mb-3">å¦‚æœæ›æ‰‹æ©Ÿæˆ–æ€•è³‡æ–™ä¸è¦‹ï¼Œè«‹ç”¨æ­¤åŠŸèƒ½ã€‚</p>
                        <div className="flex gap-2">
                            <button onClick={exportData} className="flex-1 bg-[#0096FF] text-white p-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 shadow-sm active:scale-95 transition">
                                <Icon name="download" size={16} /> åŒ¯å‡º
                            </button>
                            <button onClick={() => fileInputRef.current.click()} className="flex-1 bg-green-500 text-white p-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 shadow-sm active:scale-95 transition">
                                <Icon name="upload" size={16} /> é‚„åŸ
                            </button>
                            <input type="file" ref={fileInputRef} className="hidden" accept=".json" onChange={importData} />
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('schedule');
            const [schedule, setSchedule] = useStickyState(initialSchedule, 'hokkaido_schedule_v1');
            const [expenses, setExpenses] = useStickyState([], 'hokkaido_expenses_v1');

            // Handle Import/Export
            const handleExport = () => {
                const data = JSON.stringify({ schedule, expenses }, null, 2);
                const blob = new Blob([data], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `hokkaido_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if (data.schedule && data.expenses) {
                            if(confirm("ç¢ºå®šé‚„åŸï¼Ÿé€™æœƒè¦†è“‹ç›®å‰çš„è³‡æ–™ã€‚")) {
                                setSchedule(data.schedule);
                                setExpenses(data.expenses);
                                alert("é‚„åŸæˆåŠŸï¼");
                            }
                        } else {
                            alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤");
                        }
                    } catch(err) { alert("è®€å–å¤±æ•—"); }
                };
                reader.readAsText(file);
                e.target.value = null;
            };

            const handleReset = () => {
                if(confirm("ç¢ºå®šåˆªé™¤æ‰€æœ‰è³‡æ–™å›åˆ°é è¨­å€¼ï¼Ÿç„¡æ³•å¾©åŸå–”ï¼")) {
                    localStorage.removeItem('hokkaido_schedule_v1');
                    localStorage.removeItem('hokkaido_expenses_v1');
                    window.location.reload();
                }
            };

            return (
                <div className="min-h-screen pb-safe max-w-md mx-auto relative bg-[var(--sakura-bg)] shadow-2xl min-h-[100dvh]">
                    <SakuraBg />
                    
                    {/* Top Bar */}
                    <header className="sticky top-0 z-40 bg-white/80 backdrop-blur-md px-4 py-3 shadow-sm flex justify-between items-center border-b border-gray-100">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-[#0096FF] rounded-full flex items-center justify-center text-white border-2 border-white shadow-sm relative">
                                <div className="absolute top-0 right-0 w-2 h-2 bg-[#E60033] rounded-full border border-white"></div>
                                <Icon name="smile" size={18} />
                            </div>
                            <h1 className="font-black text-lg text-[#0096FF] tracking-wide">åŒ—æµ·é“ä¹‹æ—…</h1>
                        </div>
                        <span className="text-xs font-bold text-[#E60033] bg-red-50 px-2 py-1 rounded-full border border-red-100">
                            4/22 - 4/28
                        </span>
                    </header>

                    {/* Content */}
                    <main className="pt-4">
                        {activeTab === 'schedule' && <ScheduleTab data={schedule} setData={setSchedule} />}
                        {activeTab === 'budget' && <BudgetTab expenses={expenses} setExpenses={setExpenses} />}
                        {activeTab === 'utility' && <UtilityTab resetData={handleReset} exportData={handleExport} importData={handleImport} />}
                    </main>

                    {/* Bottom Nav */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur border-t border-gray-200 z-50 pb-safe max-w-md mx-auto">
                        <div className="flex justify-around items-center p-2">
                            <button 
                                onClick={() => setActiveTab('schedule')}
                                className={`flex flex-col items-center p-2 rounded-xl transition w-16 ${activeTab === 'schedule' ? 'text-[#0096FF] bg-blue-50' : 'text-gray-400'}`}
                            >
                                <Icon name="calendar-heart" size={24} />
                                <span className="text-[10px] font-bold mt-1">è¡Œç¨‹</span>
                            </button>
                            <button 
                                onClick={() => setActiveTab('budget')}
                                className={`flex flex-col items-center p-2 rounded-xl transition w-16 ${activeTab === 'budget' ? 'text-[#0096FF] bg-blue-50' : 'text-gray-400'}`}
                            >
                                <Icon name="wallet" size={24} />
                                <span className="text-[10px] font-bold mt-1">è¨˜å¸³</span>
                            </button>
                            <button 
                                onClick={() => setActiveTab('utility')}
                                className={`flex flex-col items-center p-2 rounded-xl transition w-16 ${activeTab === 'utility' ? 'text-[#0096FF] bg-blue-50' : 'text-gray-400'}`}
                            >
                                <div className="relative">
                                    <Icon name="layout-grid" size={24} />
                                    <div className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-[#E60033] rounded-full border-2 border-white"></div>
                                </div>
                                <span className="text-[10px] font-bold mt-1">ç™¾å¯¶è¢‹</span>
                            </button>
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>